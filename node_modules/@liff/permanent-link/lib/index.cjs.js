"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var r=require("tslib"),e=require("@liff/consts"),t=require("@liff/util"),n=require("@liff/store"),i=require("@liff/use"),a=/([\x90\x9D\x81\x8D\x8F<"{|}>\\^`“›„•‚ŽŠ…’—ž–‘”‡™‰ŒšŸ‹œ†¥¿©áÄýÍÎðô]|\n|.*#.*#|%(?![0-9A-Fa-f]{2})[^%]{0,2})/,o=function(r){if(a.test(r))throw t.createLiffError(e.INVALID_ARGUMENT,"invalid URL.");var n=new URL(r),i=n.username,o=n.password,s=n.hash,f=n.search;return{username:i,password:o,pathname:n.pathname,hash:s,origin:n.origin,search:f.replace(/(?:^|;|&)([^;&]*)[;&]*(?=($|;|&))/g,"$1&").replace(/&+$/g,"").replace(/^\?&/,"?")}},s=function(r){return r.substring(1).split("&").filter((function(r){return!/^liff\./.test(r)&&Boolean(r)}))},f=function(r,e){var t=r.substring(e.length);return"/"===t?"":(t.length>0&&"/"!==t[0]&&(t="/"+t),t)},u=function(e,t){var n,i,a,o=function(e,t){for(var n=r.__spreadArray([],r.__read(e),!1),i=0;i<t.length;i++){var a=t[i],o=n.indexOf(a);o>-1&&n.splice(o,1)}return n}((n=s(e).join("&"),i=new URLSearchParams(n).toString().split("&"),a=n.split("&"),i.map((function(r,e){return r.endsWith("=")&&!a[e].endsWith("=")?r.slice(0,-1):r}))),s(t)).join("&");return""!==o?"?".concat(o):""},c=function(r){var t=new RegExp("^".concat(e.CREDENTIAL_KEYS.join("|"))),n=r.substring(1).split("&").filter((function(r){return!t.test(r)&&Boolean(r)})).join("&");return n?"#".concat(n):""},l=function(r,e){return 0===e.indexOf(r)&&(r.endsWith("/")&&(r=r.substring(0,r.length-1)),void 0===e[r.length]||"/"===e[r.length])},p=function(r,n){var i=o(r),a=new URL(n);if(i.username!==a.username||i.password!==a.password)throw t.createLiffError(e.INVALID_ARGUMENT,"invalid URL.");if(a.origin!==i.origin||!l(a.pathname,i.pathname))throw t.createLiffError(e.INVALID_ARGUMENT,"invalid URL.")},h=function(i){function a(){var a=null!==i&&i.apply(this,arguments)||this;return a.extraParams="",a.getAndValidateContext=function(){var r=n.getContext();if(!r)throw t.createLiffError(e.INIT_FAILED,"Could not get Context from server.");if(!r.endpointUrl)throw t.createLiffError(e.INIT_FAILED,"Could not get endpointUrl from server.");if(!r.permanentLinkPattern)throw t.createLiffError(e.INIT_FAILED,"Could not get permanentLinkPattern from server.");return r},a.createUrl=function(){var r=a.getAndValidateContext(),i=window.location,o=i.pathname,s=i.search,f=i.hash,u=i.origin,c=new URL(r.endpointUrl);if(c.origin!==u||!l(c.pathname,o))throw t.createLiffError(e.INVALID_CONFIG,"Current page is not under entrypoint.");var p=o.substring(c.pathname.length);p.length>0&&"/"!==p[0]&&(p="/"+p);var h=new RegExp("^".concat(e.CREDENTIAL_KEYS.join("|"))),d=f.substring(1).split("&").filter((function(r){return!h.test(r)&&Boolean(r)})).join("&"),g=d===c.hash.substring(1)?"":d,m=function(r){return r.substring(1).split("&").filter((function(r){return!/liff\.state/.test(r)&&Boolean(r)}))},I=m(s),L=m(c.search);a.extraParams&&I.push(a.extraParams);for(var E=0;E<L.length;E++){var _=L[E],v=I.indexOf(_);v>-1&&I.splice(v,1)}var x=I.join("&"),N="".concat(p).concat(""!==x?"?".concat(x):"").concat(g?"#".concat(g):"");return"".concat(e.PERMANENT_LINK_ORIGIN).concat(n.getConfig().liffId).concat(N)},a.createUrlBy=function(i){return r.__awaiter(a,void 0,void 0,(function(){var a,s,l,h,d,g;return r.__generator(this,(function(r){if(!(a=n.getConfig().liffId))throw t.createLiffError(e.INIT_FAILED,"Should run after liff init.");return s=this.getAndValidateContext(),p(i,s.endpointUrl),l=o(i),h=new URL(s.endpointUrl),d=s.miniDomainAllowed?e.PERMANENT_LINK_ORIGIN_MINI:e.PERMANENT_LINK_ORIGIN,g=s.miniDomainAllowed&&s.miniAppId?s.miniAppId:a,[2,d.concat(g,f(l.pathname,h.pathname),u(l.search,h.search),c(l.hash))]}))}))},a.setExtraQueryParam=function(r){a.extraParams=r},a.install=function(){return{createUrl:a.createUrl,createUrlBy:a.createUrlBy,setExtraQueryParam:a.setExtraQueryParam}},a}return r.__extends(a,i),Object.defineProperty(a.prototype,"name",{get:function(){return"permanentLink"},enumerable:!1,configurable:!0}),a}(i.LiffModule),d=new h;exports.PermanentLinkModule=h,exports.module=d,exports.validatePermalinkGeneratability=p;
